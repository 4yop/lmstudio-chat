<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LZH的AI对话程序 - Vue版</title>

    <script src="lib/marked.min.js"></script>
    <link rel="stylesheet" href="lib/github-dark.min.css">
    <script src="lib/highlight.min.js"></script>

    <script src="lib/vue.global.js"></script>

    <style>
        :root {
            --bg: #f7f7f8;
            --panel: #ffffff;
            --user: #dcf8c6;
            --assistant: #f1f0f0;
            --border: #e5e7eb;
            --primary: #10a37f;
            --menu-bg: #202123;
            --menu-item-hover: #343541;
            --text-light: #ececf1;
            --menu-width: 260px;
            --menu-collapsed-width: 0px;
        }

        * { box-sizing: border-box; }

        #app {
            max-width: 100%;
            margin: 0;
            background: var(--bg);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* 侧边栏样式 */
        #menu {
            width: var(--menu-width);
            background: var(--menu-bg);
            color: var(--text-light);
            display: flex;
            flex-direction: column;
            padding: 10px;
            flex-shrink: 0;
            overflow-y: auto;
            position: relative;
            z-index: 100;
            transition: width 0.3s ease-in-out, padding 0.3s ease-in-out, left 0.3s ease-in-out;
        }

        #menu.collapsed {
            width: var(--menu-collapsed-width);
            padding: 0;
            overflow: hidden;
        }

        .menu-header { margin-bottom: 10px; }

        #history-list {
            flex-grow: 1;
            overflow-y: auto;
            padding: 5px 0;
            border-top: 1px solid #3e3e44;
        }

        .chat-item {
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 5px;
            cursor: pointer;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 0.95em;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-item:hover,
        .chat-item.active { background: var(--menu-item-hover); }

        .chat-item .del-btn {
            background: transparent;
            border: none;
            color: #888;
            padding: 0 8px;
            font-size: 1.2em;
            cursor: pointer;
            display: none;
        }

        .chat-item:hover .del-btn { display: block; }

        /* 主内容 */
        #main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        header {
            background: var(--panel);
            border-bottom: 1px solid var(--border);
            padding: 10px 16px;
            flex-shrink: 0;
        }

        .header-inner {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        #menu-toggle-btn {
            background: none;
            color: #333;
            font-size: 1.5em;
            border: none;
            cursor: pointer;
        }

        /* 聊天区 */
        #chat {
            flex: 1;
            overflow-y: auto;
            padding: 12px 8px 100px; /* 底部预留 */
        }

        .msg {
            max-width: 90%;
            margin: 0 auto 12px;
            padding: 10px 14px;
            border-radius: 12px;
            line-height: 1.6;
            font-size: 15px;
            word-break: break-word;
        }

        .user { margin-left: auto; background: var(--user); }
        .assistant { margin-right: auto; background: var(--assistant); }

        /* Markdown 表格样式 */
        .assistant table, .assistant th, .assistant td {
            border: 1px solid #000;
            border-collapse: collapse;
        }
        .assistant th, .assistant td { padding: 6px 10px; }

        .assistant pre {
            background: #0d1117;
            color: #c9d1d9;
            padding: 10px;
            border-radius: 6px;
            overflow-x: auto;
        }

        /* 输入区 */
        footer {
            background: var(--panel);
            border-top: 1px solid var(--border);
            padding: 8px;
            position: absolute;
            bottom: 0;
            right: 0;
            z-index: 20;
            transition: left 0.3s ease-in-out, width 0.3s ease-in-out;
        }

        .input-wrap { display: flex; gap: 8px; }

        textarea {
            flex: 1;
            resize: none;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px;
            font-size: 15px;
            min-height: 40px;
        }

        .send-btn {
            background: var(--primary);
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 0 12px;
            cursor: pointer;
        }

        .send-btn.stop { background: #e34b4b; }

        /* 移动端适配 */
        @media (max-width: 768px) {
            #menu {
                position: absolute;
                height: 100vh;
                left: calc(0px - var(--menu-width));
            }
            #menu.open { left: 0; }
            footer { left: 0 !important; width: 100% !important; }
        }

        /* 思考过程样式 */
        details.thinking {
            background: #fcfcfc;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 8px 12px;
            margin-bottom: 10px;
            font-size: 0.9em;
        }
        .thinking-content { white-space: pre-wrap; font-family: monospace; color: #444; }

        /* 加载动画 */
        .loading-dot {
            display: inline-block;
            width: 8px; height: 8px;
            border-radius: 50%;
            background: #888;
            margin: 0 2px;
            animation: dot-loading 1.5s infinite;
        }
        @keyframes dot-loading {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }
    </style>
</head>

<body>
<div id="app">
    <aside id="menu" :class="{ collapsed: isCollapsed, open: isMobileOpen }">
        <div class="menu-header">
            <button @click="startNewChat" style="width: 100%; background: #3e3e44; color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer;">
                + 新建对话
            </button>
        </div>

        <div id="history-list">
            <div v-for="item in conversations"
                 :key="item.id"
                 class="chat-item"
                 :class="{ active: currentConversationId == item.id }"
                 @click="selectConversation(item)">
                <span style="flex: 1; overflow: hidden; text-overflow: ellipsis;">{{ item.title || '无标题会话' }}</span>
                <button class="del-btn" @click.stop="deleteConversation(item.id)">×</button>
            </div>
        </div>

        <div class="menu-footer" style="padding-top: 10px; border-top: 1px solid #3e3e44; text-align: center; font-size: 0.8em; color: #888;">
            Local LLM Chat V1.0 (Vue)
        </div>
    </aside>

    <div id="main-content">
        <header>
            <div class="header-inner">
                <button id="menu-toggle-btn" @click="toggleMenu">☰</button>
                <strong>LZH的AI对话程序</strong>
                <div style="width: 30px;"></div> </div>
        </header>

        <div id="chat" ref="chatBox" @scroll="handleScroll">
            <div v-if="messages.length === 0" class="msg assistant">
                请从左侧选择会话或开始新的对话。
            </div>

            <div v-for="(msg, index) in messages"
                 :key="index"
                 :class="['msg', msg.role]"
                 v-html="renderMarkdown(msg.content, msg.role)">
            </div>

            <div v-if="isGenerating && currentStreamText" class="msg assistant" v-html="renderMarkdown(currentStreamText, 'assistant')">
            </div>

            <div v-if="isGenerating && !currentStreamText" class="msg assistant">
                <span class="loading-dot"></span><span class="loading-dot"></span><span class="loading-dot"></span>
            </div>
        </div>

        <footer :style="footerStyle">
            <div class="input-wrap">
                    <textarea
                            v-model="inputText"
                            @keydown.enter.prevent="handleEnter"
                            :disabled="isGenerating"
                            placeholder="Enter 换行｜Ctrl + Enter 发送"
                            rows="1"
                            ref="inputArea"
                    ></textarea>
                <button
                        class="send-btn"
                        :class="{ stop: isGenerating }"
                        @click="isGenerating ? stopGeneration() : send()">
                    {{ isGenerating ? '停止' : '发送' }}
                </button>
            </div>
        </footer>
    </div>
</div>

<script>
    const { createApp } = Vue;

    createApp({
        data() {
            return {
                // API 配置
                BASE: '',
                CHAT_API: '/message/send',
                CONVERSATION_HISTORY_API: '/conversation/history',
                MESSAGE_HISTORY_API: '/message/history',
                DELETE_CONVERSATION_API: '/conversation/delete',

                // 状态
                conversations: [],
                messages: [],
                currentConversationId: null,
                inputText: '',
                isGenerating: false,
                isCollapsed: false,
                isMobileOpen: false,
                currentStreamText: '',

                // 分页
                isLoadingMore: false,
                minMessageId: null,

                // 控制
                abortController: null,
                decoder: new TextDecoder(),
            };
        },
        computed: {
            footerStyle() {
                // 计算 PC 端侧边栏折叠对 footer 宽度的影响
                if (window.innerWidth <= 768) return { left: 0, width: '100%' };
                const width = this.isCollapsed ? '0px' : '260px';
                return {
                    left: width,
                    width: `calc(100% - ${width})`
                };
            }
        },
        watch: {
            // 每次消息更新自动滚动到底部
            messages: {
                handler() { this.scrollToBottom(); },
                deep: true
            },
            currentStreamText() { this.scrollToBottom(); }
        },
        mounted() {
            this.loadConversationHistory();
            window.addEventListener('resize', this.handleResize);

            // 配置 marked
            marked.setOptions({
                gfm: true, breaks: true, headerIds: false, mangle: false
            });
        },
        methods: {
            // --- 核心业务逻辑 ---
            async loadConversationHistory() {
                try {
                    const res = await fetch(this.BASE + this.CONVERSATION_HISTORY_API);
                    const data = await res.json();
                    if (data.code === 1) this.conversations = data.data || [];
                } catch (e) { console.error("加载列表失败", e); }
            },

            async selectConversation(item) {
                this.currentConversationId = item.id;
                this.messages = [];
                this.minMessageId = null;
                if (window.innerWidth <= 768) this.isMobileOpen = false;
                await this.loadMessages(item.id);
            },

            async loadMessages(conversationId, beforeId = null) {
                if (this.isLoadingMore) return;
                this.isLoadingMore = true;

                const chatBox = this.$refs.chatBox;
                const oldHeight = chatBox.scrollHeight;

                try {
                    let url = `${this.BASE}${this.MESSAGE_HISTORY_API}?conversation_id=${conversationId}&limit=20`;
                    if (beforeId) url += `&last_id=${beforeId}`;

                    const res = await fetch(url);
                    const json = await res.json();

                    if (json.code === 1 && json.data.length > 0) {
                        const newList = json.data;
                        this.minMessageId = newList[0].id;

                        if (beforeId) {
                            this.messages = [...newList, ...this.messages];
                            // 保持滚动位置
                            this.$nextTick(() => {
                                chatBox.scrollTop = chatBox.scrollHeight - oldHeight;
                            });
                        } else {
                            this.messages = newList;
                        }
                    }
                } finally {
                    this.isLoadingMore = false;
                }
            },

            async send() {
                if (!this.inputText.trim() || this.isGenerating) return;

                const userMsg = this.inputText;
                this.messages.push({ role: 'user', content: userMsg });
                this.inputText = '';

                this.isGenerating = true;
                this.currentStreamText = '';
                this.abortController = new AbortController();

                try {
                    const res = await fetch(this.BASE + this.CHAT_API, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            content: userMsg,
                            conversation_id: this.currentConversationId
                        }),
                        signal: this.abortController.signal
                    });

                    const reader = res.body.getReader();
                    let buffer = '';

                    while (true) {
                        const { value, done } = await reader.read();
                        if (done) break;

                        buffer += this.decoder.decode(value, { stream: true });
                        const lines = buffer.split('}');
                        buffer = lines.pop();

                        for (let line of lines) {
                            line = line.trim() + '}';
                            if (line.length < 3) continue;
                            try {
                                const json = JSON.parse(line);
                                if (json.conversationId) this.currentConversationId = json.conversationId;

                                if (json.type === 'stream') {
                                    this.currentStreamText += json.content || '';
                                } else if (json.type === 'end') {
                                    // 结束后存入正式数组
                                    this.messages.push({ role: 'assistant', content: this.currentStreamText });
                                    this.currentStreamText = '';
                                    // 如果是新会话，刷新左侧列表
                                    this.loadConversationHistory();
                                }
                            } catch (e) {}
                        }
                    }
                } catch (error) {
                    if (error.name === 'AbortError') {
                        this.messages.push({ role: 'assistant', content: this.currentStreamText + '\n\n(已停止生成)' });
                    } else {
                        alert('请求失败: ' + error.message);
                    }
                } finally {
                    this.isGenerating = false;
                    this.currentStreamText = '';
                    this.abortController = null;
                }
            },

            // --- 辅助功能 ---
            renderMarkdown(text, role) {
                if (role === 'user') return text;

                // 处理思考标签
                let processed = text.replace(/<think>/g, '<details class="thinking" open><summary>思考过程 (Thinking)</summary><div class="thinking-content">');
                processed = processed.replace(/<\/think>/g, '</div></details>');

                const html = marked.parse(processed);

                // 异步触发高亮（Vue 渲染完成后）
                this.$nextTick(() => {
                    this.$refs.chatBox.querySelectorAll('pre code').forEach(el => hljs.highlightElement(el));
                });

                return html;
            },

            handleEnter(e) {
                if (e.ctrlKey || e.metaKey) {
                    this.send();
                } else {
                    this.inputText += '\n';
                }
            },

            startNewChat() {
                this.currentConversationId = null;
                this.messages = [];
                this.isMobileOpen = false;
            },

            async deleteConversation(id) {
                if (!confirm('确定删除吗？')) return;
                try {
                    const res = await fetch(this.BASE + this.DELETE_CONVERSATION_API, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ conversation_id: id })
                    });
                    if (id === this.currentConversationId) this.startNewChat();
                    this.loadConversationHistory();
                } catch (e) {}
            },

            stopGeneration() {
                if (this.abortController) this.abortController.abort();
            },

            toggleMenu() {
                if (window.innerWidth <= 768) {
                    this.isMobileOpen = !this.isMobileOpen;
                } else {
                    this.isCollapsed = !this.isCollapsed;
                }
            },

            scrollToBottom() {
                this.$nextTick(() => {
                    const chat = this.$refs.chatBox;
                    if (chat) chat.scrollTop = chat.scrollHeight;
                });
            },

            handleScroll(e) {
                if (e.target.scrollTop === 0 && this.minMessageId && !this.isLoadingMore) {
                    this.loadMessages(this.currentConversationId, this.minMessageId);
                }
            },

            handleResize() {
                if (window.innerWidth > 768) this.isMobileOpen = false;
            }
        }
    }).mount('#app');
</script>
</body>
</html>