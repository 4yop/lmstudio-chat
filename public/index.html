<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LZHçš„AIå¯¹è¯ç¨‹åº</title>

    <script src="lib/marked.min.js"></script>

    <link rel="stylesheet" href="lib/github-dark.min.css">
    <script src="lib/highlight.min.js"></script>

    <style>
        :root {
            --bg: #f7f7f8;
            --panel: #ffffff;
            --user: #dcf8c6;
            --assistant: #f1f0f0;
            --border: #e5e7eb;
            --primary: #10a37f;
            --menu-bg: #202123;
            /* ä¾§è¾¹æ èƒŒæ™¯ */
            --menu-item-hover: #343541;
            /* ä¾§è¾¹æ é¡¹æ‚¬åœ */
            --text-light: #ececf1;
            --menu-width: 260px;
            /* é»˜è®¤å®½åº¦ */
            --menu-collapsed-width: 0px;
            /* PCç«¯éšè—åçš„å®½åº¦ */
        }

        * {
            box-sizing: border-box;
        }

        #app {
            max-width: 100%;
            margin: 0;
            background: var(--bg);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* ä¾§è¾¹æ æ ·å¼ (PC/é»˜è®¤çŠ¶æ€) */
        #menu {
            width: var(--menu-width);
            background: var(--menu-bg);
            color: var(--text-light);
            display: flex;
            flex-direction: column;
            padding: 10px;
            flex-shrink: 0;
            overflow-y: auto;
            position: relative;
            z-index: 10;
            transition: width 0.3s ease-in-out, padding 0.3s ease-in-out;
            /* PCæŠ˜å åŠ¨ç”» */
        }

        /* PCç«¯æŠ˜å çŠ¶æ€ */
        #menu.collapsed {
            width: var(--menu-collapsed-width);
            padding: 0;
            overflow: hidden;
        }

        /* ä¾§è¾¹æ å†…éƒ¨å…ƒç´ åœ¨æŠ˜å æ—¶éšè— */
        #menu.collapsed .menu-header,
        #menu.collapsed #history-list,
        #menu.collapsed .menu-footer {
            opacity: 0;
            transition: opacity 0.1s;
        }


        .menu-header {
            margin-bottom: 10px;
        }

        #history-list {
            flex-grow: 1;
            overflow-y: auto;
            padding: 5px 0;
            border-top: 1px solid #3e3e44;
        }

        .chat-item {
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 5px;
            cursor: pointer;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 0.95em;
        }

        .chat-item:hover,
        .chat-item.active {
            background: var(--menu-item-hover);
        }

        #load-more-btn {
            width: 100%;
            background: none;
            color: #ccc;
            border: 1px dashed #555;
            margin-top: 10px;
        }

        #load-more-btn:hover {
            color: #fff;
            border-color: #fff;
        }


        /* ä¸»å†…å®¹åŒºåŸŸ */
        #main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* é¡¶æ  */
        header {
            background: var(--panel);
            border-bottom: 1px solid var(--border);
            padding: 10px 16px;
            flex-shrink: 0;
        }

        .header-inner {
            max-width: 100%;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        /* PCç«¯èœå•åˆ‡æ¢æŒ‰é’®ï¼ˆå§‹ç»ˆå¯è§ï¼‰ */
        #menu-toggle-btn {
            background: none;
            color: #333;
            font-size: 1.5em;
            border: none;
            padding: 0 5px;
            cursor: pointer;
            height: auto;
        }

        select {
            padding: 6px 10px;
            border-radius: 8px;
            border: 1px solid var(--border);
            font-size: 14px;
            max-width: 200px;
            min-width: 100px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* èŠå¤©åŒº */
        #chat {
            flex: 1;
            overflow-y: auto;
            padding: 12px 8px;
            margin-bottom: 70px;
            /* ç•™å‡ºåº•éƒ¨è¾“å…¥åŒºç©ºé—´ */
        }

        /* æ¶ˆæ¯ (ä¿æŒä¸å˜) */
        .msg {
            max-width: 90%;
            margin: 0 auto 12px;
            padding: 10px 14px;
            border-radius: 12px;
            line-height: 1.6;
            font-size: 15px;
            word-break: break-word;
            word-wrap: break-word;
        }

        .user {
            margin-left: auto;
            background: var(--user);
        }

        .assistant {
            margin-right: auto;
            background: var(--assistant);
        }

        .assistant pre {
            background: #0d1117;
            color: #c9d1d9;
            padding: 10px;
            border-radius: 6px;
            overflow-x: auto;
        }

        .assistant code {
            background: #e5e7eb;
            padding: 2px 4px;
            border-radius: 4px;
        }

        .loading-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #888;
            margin: 0 2px;
            animation: dot-loading 1.5s infinite;
        }

        .loading-dot:nth-child(2) {
            animation-delay: 0.5s;
        }

        .loading-dot:nth-child(3) {
            animation-delay: 1s;
        }

        @keyframes dot-loading {

            0%,
            80%,
            100% {
                transform: scale(0);
            }

            40% {
                transform: scale(1.0);
            }
        }


        /* è¾“å…¥åŒº */
        footer {
            background: var(--panel);
            border-top: 1px solid var(--border);
            padding: 8px;
            position: fixed;
            bottom: 0;
            /* PCç«¯é»˜è®¤ä» 260px å¼€å§‹ */
            left: var(--menu-width);
            right: 0;
            width: calc(100% - var(--menu-width));
            z-index: 20;
            transition: left 0.3s ease-in-out, width 0.3s ease-in-out;
            /* éšèœå•æŠ˜å åŠ¨ç”» */
        }

        /* PCç«¯æŠ˜å æ—¶çš„ Footer æ ·å¼ */
        #menu.collapsed~#main-content footer {
            left: var(--menu-collapsed-width);
            width: calc(100% - var(--menu-collapsed-width));
        }

        .input-wrap {
            max-width: 100%;
            margin: 0 auto;
            display: flex;
            gap: 8px;
        }

        textarea {
            flex: 1;
            resize: none;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px;
            font-size: 15px;
            line-height: 1.5;
            max-height: 150px;
            min-height: 40px;
        }

        textarea:disabled {
            background: #f3f4f6;
        }

        button {
            background: var(--primary);
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 0 12px;
            font-size: 14px;
            cursor: pointer;
            white-space: nowrap;
            height: 40px;
        }

        button:disabled {
            background: #9ca3af;
        }


        /* ------------------------------------------- */
        /* ç§»åŠ¨ç«¯è¦†ç›–æ ·å¼ (å°äº 768px)                   */
        /* ------------------------------------------- */

        @media (max-width: 768px) {

            /* ç§»åŠ¨ç«¯ä¾§è¾¹æ æ”¹ä¸ºç»å¯¹å®šä½ï¼ŒæŠ½å±‰æ•ˆæœï¼Œå¿½ç•¥ .collapsed */
            #menu {
                position: absolute;
                height: 100vh;
                width: var(--menu-width);
                /* å®½åº¦æ’å®š */
                left: calc(0px - var(--menu-width));
                /* é»˜è®¤å®Œå…¨éšè— */
                top: 0;
                padding: 10px;
                transition: left 0.3s ease-in-out;
                box-shadow: 2px 0 5px rgba(0, 0, 0, 0.5);
                z-index: 100;
            }

            /* ç§»åŠ¨ç«¯æ‰“å¼€æ—¶çš„æ ·å¼ */
            #menu.open {
                left: 0;
            }

            /* ç¡®ä¿ç§»åŠ¨ç«¯æ‰“å¼€æ—¶å†…éƒ¨å…ƒç´ å¯è§ */
            #menu.open .menu-header,
            #menu.open #history-list,
            #menu.open .menu-footer {
                opacity: 1;
            }

            /* ç§»åŠ¨ç«¯ Footer å æ®å…¨å®½ï¼Œä¸ç•™ç©ºéš™ */
            footer {
                left: 0;
                width: 100%;
            }

            /* ç¡®ä¿ main-content å æ®å‰©ä½™å®½åº¦ */
            #main-content {
                width: 100%;
            }
        }

        /* æ€è€ƒè¿‡ç¨‹æ ·å¼ */
        details.thinking {
            background: #fcfcfc;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 8px 12px;
            margin-bottom: 10px;
            font-size: 0.9em;
            color: #666;
        }

        details.thinking summary {
            cursor: pointer;
            font-weight: 500;
            color: #888;
            outline: none;
        }

        details.thinking .thinking-content {
            margin-top: 8px;
            white-space: pre-wrap;
            font-family: monospace;
            color: #444;
        }

        /* æš—é»‘æ¨¡å¼é€‚é… (å¯é€‰) */
        @media (prefers-color-scheme: dark) {
            details.thinking {
                background: #2a2b32;
                border-color: #3e3e44;
                color: #aaa;
            }
        }
    </style>
    <script>
        /**
         * å¤„ç†æ€è€ƒæ ‡ç­¾ï¼Œå°†å…¶è½¬æ¢ä¸º HTML details å…ƒç´ 
         */
        function processThinkingTags(text) {
            // ä½¿ç”¨æ­£åˆ™æ›¿æ¢ <think>...</think> ä¸º <details>...</details>
            // æ³¨æ„ï¼šæµå¼ä¼ è¾“æ—¶ <think> å¯èƒ½é—­åˆä¹Ÿå¯èƒ½æ²¡é—­åˆï¼Œè¿™é‡Œä¸»è¦å¤„ç†æœ€ç»ˆæ¸²æŸ“æˆ–è¶³å¤Ÿé•¿çš„ç‰‡æ®µ
            // ç®€å•å¤„ç†ï¼šå°† <think> æ›¿æ¢ä¸º <details class="thinking" open><summary>æ€è€ƒè¿‡ç¨‹</summary><div class="thinking-content">
            // å°† </think> æ›¿æ¢ä¸º </div></details>

            // 1. æ›¿æ¢å¼€å§‹æ ‡ç­¾
            let processed = text.replace(/<think>/g, '<details class="thinking" open><summary>æ€è€ƒè¿‡ç¨‹ (Thinking)</summary><div class="thinking-content">');

            // 2. æ›¿æ¢ç»“æŸæ ‡ç­¾
            processed = processed.replace(/<\/think>/g, '</div></details>');

            return processed;
        }
    </script>
</head>

<body>
    <div id="app">

        <aside id="menu">
            <div class="menu-header">
                <button id="new-chat-btn" style="width: 100%; background: #3e3e44;">+ æ–°å»ºå¯¹è¯</button>
            </div>

            <div id="history-list">
            </div>

            <div class="menu-footer"
                style="padding-top: 10px; border-top: 1px solid #3e3e44; text-align: center; font-size: 0.8em; color: #888;">
                Local LLM Chat V1.0
            </div>
        </aside>

        <div id="main-content">
            <header>
                <div class="header-inner">
                    <button id="menu-toggle-btn">â˜°</button>
                    <strong>LZHçš„AIå¯¹è¯ç¨‹åº</strong>
                    <select id="modelSelect" disabled></select>
                </div>
            </header>

            <div id="chat">
                <div class="msg assistant" id="initial-msg">è¯·ä»å·¦ä¾§é€‰æ‹©ä¼šè¯æˆ–å¼€å§‹æ–°çš„å¯¹è¯ã€‚</div>
            </div>
        </div>


        <footer>
            <div class="input-wrap">
                <textarea id="input" rows="1" placeholder="Enter æ¢è¡Œï½œCtrl + Enter å‘é€"></textarea>
                <button id="send">å‘é€</button>
            </div>
        </footer>

    </div>


    <script>
        /* ================= é…ç½® ================= */
        // å°† BASE è®¾ç½®ä¸º Node æœåŠ¡åœ°å€ (3000ç«¯å£)
        // å¦‚æœæ‚¨é€šè¿‡ http://localhost:3000 è®¿é—®é¡µé¢ï¼Œå¯ä»¥è®¾ä¸º ''
        // å¦‚æœé€šè¿‡ PHPStudy (http://localhost/ai-chat) è®¿é—®ï¼Œå¿…é¡»è®¾ä¸º 'http://localhost:3000'
        const BASE = '';
        // æ¥å…¥æ‚¨çš„ Express API è·¯ç”±
        const CHAT_API = BASE + '/message/send';
        const CONVERSATION_HISTORY_API = BASE + '/conversation/history';
        const MESSAGE_HISTORY_API = BASE + '/message/history';

        const MOBILE_BREAKPOINT = 768;

        marked.setOptions({
            gfm: true, breaks: true, headerIds: false, mangle: false
        });

        const chat = document.getElementById('chat');
        const input = document.getElementById('input');
        const sendBtn = document.getElementById('send');
        const modelSelect = document.getElementById('modelSelect');
        const menu = document.getElementById('menu');
        const newChatBtn = document.getElementById('new-chat-btn');
        const historyList = document.getElementById('history-list');
        const menuToggleBtn = document.getElementById('menu-toggle-btn');
        const initialMsg = document.getElementById('initial-msg');

        // éšè—æ¨¡å‹é€‰æ‹©å™¨ï¼Œå› ä¸ºåç«¯ä¸æ”¯æŒ
        if (modelSelect) modelSelect.style.display = 'none';

        let isGenerating = false;
        let raw = '';
        let rafLock = false;
        let currentConversationId = null; // ğŸ’¡ å½“å‰æ¿€æ´»çš„ä¼šè¯ ID
        let lastConversationId = null;    // ğŸ’¡ ç”¨äºåˆ†é¡µåŠ è½½çš„æœ€å°ä¼šè¯ ID
        const decoder = new TextDecoder();
        let abortController = null; // ç”¨äºä¸­æ­¢è¯·æ±‚

        // åˆ†é¡µå’Œå†å²è®°å½•çŠ¶æ€
        let isLoadingMore = false;
        let minMessageId = null;
        let history = [];

        /* ================= å·¥å…·å‡½æ•° ================= */
        /**
         * æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©åŒºåŸŸ
         * @param {string} role 'user' æˆ– 'assistant'
         * @param {string} content æ¶ˆæ¯å†…å®¹
         * @param {boolean} [isMarkdown=true] æ˜¯å¦æ¸²æŸ“ä¸º Markdown
         */
        function addMsg(role, content, isMarkdown = true) {
            const div = document.createElement('div');
            div.className = `msg ${role}`;

            if (role === 'user' || !isMarkdown) {
                div.textContent = content;
            } else {
                // å…ˆå¤„ç†æ€è€ƒæ ‡ç­¾
                const processedContent = processThinkingTags(content);
                div.innerHTML = marked.parse(processedContent);
                div.querySelectorAll('pre code').forEach(el => hljs.highlightElement(el));
            }

            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
            return div;
        }

        /** * å®æ—¶æ¸²æŸ“å‡½æ•° (é˜²æŠ–)
         */
        function scheduleRender(el) {
            if (rafLock) return;
            rafLock = true;
            requestAnimationFrame(() => {
                // å…ˆå¤„ç†æ€è€ƒæ ‡ç­¾
                const processedContent = processThinkingTags(raw);
                el.innerHTML = marked.parse(processedContent);
                el.querySelectorAll('pre code').forEach(codeEl => hljs.highlightElement(codeEl));
                chat.scrollTop = chat.scrollHeight;
                rafLock = false;
            });
        }

        /**
         * å°è£…çš„ API è¯·æ±‚å‡½æ•°
         */
        async function fetchApi(url) {
            const res = await fetch(url);
            if (!res.ok) {
                throw new Error(`API Request failed: ${res.status} ${res.statusText}`);
            }
            const json = await res.json();
            if (json.code !== 1) {
                throw new Error(`API Error: ${json.msg}`);
            }
            return json.data;
        }

        /**
         * ä¾§è¾¹æ æ·»åŠ ä¼šè¯é¡¹
         */
        function addChatItem(id, title, isActive = false) {
            const div = document.createElement('div');
            div.className = `chat-item${isActive ? ' active' : ''}`;
            div.dataset.id = id;
            div.textContent = title;
            // å€’åºæ’å…¥ï¼ˆæœ€æ–°åœ¨æœ€ä¸Šé¢ï¼‰
            if (historyList.firstChild) {
                historyList.insertBefore(div, historyList.firstChild);
            } else {
                historyList.appendChild(div);
            }
            return div;
        }

        /**
         * æ›´æ–°ä¾§è¾¹æ ä¸­çš„æŸä¸ªä¼šè¯æ ‡é¢˜
         */
        function updateChatItem(id, newTitle) {
            const item = historyList.querySelector(`.chat-item[data-id="${id}"]`);
            if (item) {
                item.textContent = newTitle;
            }
        }




        /* ================= æ¶ˆæ¯åŠ è½½ (å¸¦åˆ†é¡µ) ================= */

        // ç›‘å¬æ»šåŠ¨äº‹ä»¶
        chat.addEventListener('scroll', () => {
            if (chat.scrollTop === 0 && !isLoadingMore && minMessageId && currentConversationId) {
                loadMessages(currentConversationId, minMessageId);
            }
        });

        async function loadMessages(conversationId, beforeId = null) {
            if (isLoadingMore) return; // é˜²æ­¢é‡å¤åŠ è½½

            // å¦‚æœæ˜¯åˆ‡æ¢æ–°ä¼šè¯ (æ²¡æœ‰ beforeId)ï¼Œåˆ™é€šè¿‡é‡ç½®çŠ¶æ€
            if (!beforeId) {
                currentConversationId = conversationId;
                document.querySelectorAll('.chat-item').forEach(el => {
                    el.classList.toggle('active', el.dataset.id == conversationId);
                });
                chat.innerHTML = ''; // æ¸…ç©ºå½“å‰è§†å›¾
                minMessageId = null; // é‡ç½®æœ€å°ID
                history = []; // æ¸…ç©ºå†…å­˜å†å²
            }

            isLoadingMore = true;

            // è®°å½•åŠ è½½å‰çš„æ»šåŠ¨é«˜åº¦ï¼Œç”¨äºåŠ è½½æ›´å¤šåä¿æŒä½ç½®
            const previousScrollHeight = chat.scrollHeight;

            try {
                let url = `${MESSAGE_HISTORY_API}?conversation_id=${conversationId}&limit=20`;
                if (beforeId) {
                    url += `&before_id=${beforeId}`;
                }

                const res = await fetch(url);
                const jsonResponse = await res.json(); // Parse JSON response

                if (jsonResponse.code === 1) { // Assuming code 1 for success
                    const list = jsonResponse.data || [];

                    if (list.length > 0) {
                        // æ›´æ–°æœ€å°ID (å› ä¸ºåç«¯è¿”å›æ˜¯æ­£åºï¼Œç¬¬ä¸€ä¸ªå…ƒç´ å°±æ˜¯æœ€æ—§çš„)
                        // æ³¨æ„ï¼šMessageDto å·²ç» reverse() è¿‡äº†ï¼Œæ‰€ä»¥è¿”å›çš„ list[0] æ˜¯è¯¥æ‰¹æ¬¡ä¸­æœ€æ—§çš„
                        minMessageId = list[0].id;

                        // æ¸²æŸ“æ¶ˆæ¯
                        // å¦‚æœæ˜¯åŠ è½½æ›´å¤š (æœ‰ beforeId)ï¼Œéœ€è¦ prepend
                        // å¦‚æœæ˜¯åˆå§‹åŠ è½½ (æ—  beforeId)ï¼Œç›´æ¥ append (å› ä¸º chat å·²æ¸…ç©º)

                        if (beforeId) {
                            // åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„ fragment
                            const fragment = document.createDocumentFragment();
                            list.forEach(msg => {
                                const div = document.createElement('div');
                                div.className = `msg ${msg.role}`;
                                if (msg.role === 'user') {
                                    div.textContent = msg.content;
                                } else {
                                    const processedContent = processThinkingTags(msg.content);
                                    div.innerHTML = marked.parse(processedContent);
                                    div.querySelectorAll('pre code').forEach(el => hljs.highlightElement(el));
                                }
                                fragment.appendChild(div);

                                // åŒæ—¶æ›´æ–°å†…å­˜ history (æ³¨æ„é¡ºåºï¼Œunshift)
                                history.unshift(msg);
                            });

                            chat.insertBefore(fragment, chat.firstChild);

                            // ä¿æŒæ»šåŠ¨ä½ç½®ï¼šæ–°çš„ scrollHeight - æ—§çš„ scrollHeight å°±æ˜¯æ–°å¢å†…å®¹çš„é«˜åº¦
                            // æˆ‘ä»¬åº”è¯¥æŠŠ scrollTop è®¾ç½®ä¸ºè¿™ä¸ªå·®å€¼ï¼Œè¿™æ ·ç”¨æˆ·çœ‹åˆ°çš„è§†è§’ä¸å˜
                            chat.scrollTop = chat.scrollHeight - previousScrollHeight;

                        } else {
                            // åˆå§‹åŠ è½½ (Add this block)
                            list.forEach(msg => {
                                addMsg(msg.role, msg.content);
                                history.push(msg);
                            });
                        }
                    }
                }
            } catch (e) {
                console.error('åŠ è½½æ¶ˆæ¯åˆ—è¡¨å¤±è´¥:', e.message);
            } finally {
                isLoadingMore = false;
            }
        }

        /**
         * 2. åŠ è½½æ¶ˆæ¯å†å² (Message History)
         */
        // This function is replaced by loadMessages, but keeping it for context if other parts still call it.
        // It should ideally be removed or updated to call loadMessages.
        async function loadMessageHistory(conversationId) {
            // Re-route to new logic
            loadMessages(conversationId);
        }

        /**
         * 3. åˆ‡æ¢ä¼šè¯é€»è¾‘
         */
        function selectConversation(id, title) {
            // æ¿€æ´»ä¾§è¾¹æ é¡¹ç›®
            document.querySelectorAll('.chat-item').forEach(el => el.classList.remove('active'));
            const item = historyList.querySelector(`.chat-item[data-id="${id}"]`);
            if (item) item.classList.add('active');

            currentConversationId = id;

            // åŠ è½½æ¶ˆæ¯è®°å½•
            loadMessageHistory(id);

            // ç§»åŠ¨ç«¯ï¼šåˆ‡æ¢ä¼šè¯åè‡ªåŠ¨å…³é—­èœå•
            if (window.innerWidth <= MOBILE_BREAKPOINT) {
                menu.classList.remove('open');
            }
        }


        // ä¾§è¾¹æ ï¼šä¼šè¯ç‚¹å‡»äº‹ä»¶
        historyList.addEventListener('click', (e) => {
            const item = e.target.closest('.chat-item');
            if (item && item.dataset.id != currentConversationId) {
                selectConversation(item.dataset.id, item.textContent);
            }
        });

        // æ–°å»ºå¯¹è¯æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        newChatBtn.addEventListener('click', () => {
            document.querySelectorAll('.chat-item').forEach(el => el.classList.remove('active'));
            chat.innerHTML = '<div class="msg assistant">å·²å¼€å§‹æ–°çš„å¯¹è¯ã€‚</div>';

            // é‡ç½®ä¼šè¯ IDï¼ŒæœåŠ¡å™¨ä¼šåˆ›å»ºæ–°ä¼šè¯
            currentConversationId = null;

            // ç§»åŠ¨ç«¯ï¼šæ–°å»ºå¯¹è¯åè‡ªåŠ¨å…³é—­èœå•
            if (window.innerWidth <= MOBILE_BREAKPOINT) {
                menu.classList.remove('open');
            }

            // ç¡®ä¿è¾“å…¥æ¡†å¯ç”¨
            input.disabled = false;
            sendBtn.disabled = false;
        });


        /* ================= å‘é€ (å¯¹æ¥ /message/send) ================= */

        // åœæ­¢ç”Ÿæˆå‡½æ•°
        function stopGeneration() {
            if (abortController) {
                abortController.abort();
                abortController = null;
            }
            isGenerating = false;
            input.disabled = false;
            sendBtn.disabled = false;
            sendBtn.textContent = 'å‘é€';
            sendBtn.style.backgroundColor = ''; // æ¢å¤é»˜è®¤é¢œè‰²
        }

        sendBtn.addEventListener('click', () => {
            if (isGenerating) {
                stopGeneration();
            } else {
                send();
            }
        });

        async function send() {
            if (!input.value.trim() || isGenerating) return;

            const text = input.value;
            input.value = '';
            input.style.height = 'auto';

            // 1. æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
            addMsg('user', text);

            // é”å®šè¾“å…¥å’ŒæŒ‰é’®
            isGenerating = true;
            input.disabled = true;
            // sendBtn.disabled = true; // ä¸éœ€è¦ç¦ç”¨ï¼Œæ”¹ä¸ºåœæ­¢æŒ‰é’®
            sendBtn.textContent = 'åœæ­¢';
            sendBtn.style.backgroundColor = '#e34b4b'; // çº¢è‰²åœæ­¢æ ·å¼

            raw = '';
            const msgEl = document.createElement('div');
            msgEl.className = `msg assistant`;
            msgEl.innerHTML = '<span class="loading-dot"></span><span class="loading-dot"></span><span class="loading-dot"></span>';
            chat.appendChild(msgEl);
            chat.scrollTop = chat.scrollHeight;

            // å‡†å¤‡å‘é€åˆ° Express æœåŠ¡å™¨çš„æ•°æ®
            const payload = {
                content: text,
                // åªæœ‰å½“ currentConversationId æœ‰å€¼æ—¶æ‰å‘é€
                conversation_id: currentConversationId
            };

            // åˆå§‹åŒ– AbortController
            abortController = new AbortController();

            try {
                // 2. å‘é€è¯·æ±‚åˆ°æ‚¨çš„ Express API
                const res = await fetch(CHAT_API, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    signal: abortController.signal
                });

                if (!res.ok || !res.body) {
                    const errorText = await res.text();
                    throw new Error(`API è¯·æ±‚å¤±è´¥: ${res.status} ${res.statusText}\n${errorText}`);
                }

                // æ¸…é™¤åŠ è½½åŠ¨ç”»
                msgEl.innerHTML = '';

                // 3. æ¥æ”¶å¹¶å¤„ç†æœåŠ¡å™¨è¿”å›çš„ JSON æµ
                const reader = res.body.getReader();
                let buffer = '';

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    // æœåŠ¡å™¨è¿”å›çš„ JSON å—å¯èƒ½æ˜¯è¿ç»­çš„ï¼Œå°è¯•ç”¨ '}' åˆ†å‰²
                    const lines = buffer.split('}');
                    buffer = lines.pop();

                    for (let line of lines) {
                        line = line.trim() + '}';
                        if (line.length < 3) continue;

                        try {
                            const json = JSON.parse(line);

                            if (json.conversationId)
                            {
                                currentConversationId = json.conversationId;
                            }

                            if (json.type === 'stream') {
                                // ç´¯ç§¯ AI æ–‡æœ¬
                                raw += json.content || '';
                                scheduleRender(msgEl);
                            } else if (json.type === 'end') {
                                // æ¥æ”¶åˆ°ç»“æŸæ ‡è®°ï¼Œæ›´æ–°ä¼šè¯IDå¹¶å¤„ç†åç»­
                                const newId = json.conversationId;
                                const newMessageTitle = text.substring(0, 30); // æš‚ç”¨ç”¨æˆ·æ¶ˆæ¯ä½œä¸ºæ ‡é¢˜

                                if (!currentConversationId && newId) {
                                    currentConversationId = newId;
                                    // æ·»åŠ åˆ°ä¾§è¾¹æ 
                                    addChatItem(newId, newMessageTitle, true);
                                }
                            } else if (json.type === 'error') {
                                raw += `\n\n[System Error: ${json.message}]`;
                                scheduleRender(msgEl);
                            }
                        } catch (err) {
                            console.warn('JSON Parse Error:', err);
                        }
                    }
                }

                // 4. æœ€ç»ˆæ¸²æŸ“å’Œé«˜äº®
                msgEl.innerHTML = marked.parse(raw);
                msgEl.querySelectorAll('pre code').forEach(el => hljs.highlightElement(el));

            } catch (error) {
                if (error.name === 'AbortError') {
                    // ç”¨æˆ·ä¸­æ–­
                    raw += '\n\n(å·²åœæ­¢ç”Ÿæˆ)';
                    scheduleRender(msgEl);
                } else {
                    console.error('èŠå¤©è¯·æ±‚å¤±è´¥:', error);
                    msgEl.innerHTML = marked.parse(`**[é”™è¯¯]** æ— æ³•è¿æ¥æˆ–æµä¸­æ–­ã€‚\n\n è¯¦ç»†: \`${error.message}\``);
                }
            } finally {
                // æ¢å¤çŠ¶æ€
                isGenerating = false;
                input.disabled = false;
                sendBtn.disabled = false;
                sendBtn.textContent = 'å‘é€';
                sendBtn.style.backgroundColor = '';
                abortController = null;
                // èšç„¦è¾“å…¥æ¡†
                setTimeout(() => input.focus(), 100);
            }
        }



        /* ================= å¯åŠ¨ã€è¾“å…¥ã€ä¾§è¾¹æ äº‹ä»¶ (ä¿æŒä¸å˜) ================= */
        sendBtn.onclick = send;

        input.addEventListener('keydown', e => {
            if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
                e.preventDefault();
                send();
            }
        });

        input.addEventListener('input', () => {
            input.style.height = 'auto';
            input.style.height = input.scrollHeight + 'px';
        });

        menuToggleBtn.onclick = () => {
            if (window.innerWidth <= MOBILE_BREAKPOINT) {
                menu.classList.toggle('open');
            } else {
                menu.classList.toggle('collapsed');
            }
        };

        document.addEventListener('click', (e) => {
            if (window.innerWidth > MOBILE_BREAKPOINT) return;
            const isMenuOpen = menu.classList.contains('open');
            const isClickInsideMenu = menu.contains(e.target);
            const isClickOnToggle = menuToggleBtn.contains(e.target);

            if (isMenuOpen && !isClickInsideMenu && !isClickOnToggle) {
                menu.classList.remove('open');
            }
        });

        window.addEventListener('resize', () => {
            if (window.innerWidth > MOBILE_BREAKPOINT) {
                if (menu.classList.contains('open')) {
                    menu.classList.remove('open');
                    menu.classList.remove('collapsed');
                }
            }
        });

        /* ================= ä¼šè¯ç®¡ç† ================= */
        const DELETE_CONVERSATION_API = BASE + '/conversation/delete';

        async function loadConversationHistory() {
            try {
                const res = await fetch(CONVERSATION_HISTORY_API);
                const data = await res.json();
                console.log('Conversation History Data:', data);

                if (data.code === 1) {
                    historyList.innerHTML = '';
                    const list = data.data || [];
                    list.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'chat-item';

                        const span = document.createElement('span');
                        span.textContent = item.title || 'æ— æ ‡é¢˜ä¼šè¯';
                        span.style.flex = 1;
                        span.style.overflow = 'hidden';
                        span.style.textOverflow = 'ellipsis';

                        // åˆ é™¤æŒ‰é’® (Stop propagation to prevent selection)
                        const delBtn = document.createElement('button');
                        // delBtn.innerHTML = 'Ã—'; // or use SVG
                        delBtn.textContent = 'Ã—';
                        delBtn.style.background = 'transparent';
                        delBtn.style.border = 'none';
                        delBtn.style.color = '#888';
                        delBtn.style.padding = '0 8px';
                        delBtn.style.fontSize = '1.2em';
                        delBtn.style.cursor = 'pointer';
                        delBtn.title = 'åˆ é™¤ä¼šè¯';

                        delBtn.onclick = (e) => {
                            e.stopPropagation();
                            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä¼šè¯å—ï¼Ÿ')) {
                                deleteConversation(item.id);
                            }
                        };

                        div.appendChild(span);
                        div.appendChild(delBtn);

                        div.style.display = 'flex';
                        div.style.alignItems = 'center';
                        div.style.justifyContent = 'space-between';


                        div.dataset.id = item.id;
                        div.onclick = () => selectConversation(item.id, item.title);
                        historyList.appendChild(div);
                    });
                }
            } catch (e) {
                console.error("åŠ è½½ä¼šè¯åˆ—è¡¨å¤±è´¥", e);
            }
        }

        async function deleteConversation(conversationId) {
            try {
                const res = await fetch(DELETE_CONVERSATION_API, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ conversation_id: conversationId })
                });
                const data = await res.json();
                if (data.code === 1) {
                    if (currentConversationId == conversationId) {
                        chat.innerHTML = '<div class="msg assistant">ä¼šè¯å·²åˆ é™¤ã€‚</div>';
                        currentConversationId = null;
                        minMessageId = null;
                        history = [];
                    }
                    loadConversationHistory();
                } else {
                    alert(data.msg || 'åˆ é™¤å¤±è´¥');
                }
            } catch (e) {
                console.error('åˆ é™¤ä¼šè¯å¤±è´¥:', e);
                alert('ç½‘ç»œé”™è¯¯ï¼Œæ— æ³•åˆ é™¤');
            }
        }

        /* ================= å¯åŠ¨ ================= */
        // åˆå§‹åŒ–åº”ç”¨
        function initApp() {
            console.log("App initializing...");
            loadConversationHistory();
        }

        initApp();
    </script>

</body>

</html>